<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>你的專屬折扣</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>你的專屬折扣</h1>
        <nav>
            <ul id="nav-links">
                <li class="event"><a href="#" title="促銷活動">促銷活動</a></li>
                <li class="shop"><a href="#" title="店舖管理">店舖管理</a></li>
                <li class="product"><a href="#" title="商品管理">商品管理</a></li>
                <li class="payment"><a href="#" title="金流管理">金流管理</a></li>
                <li class="customer active"><a href="#" title="顧客資料">顧客資料</a></li>
            </ul>
        </nav>
    </header>
    <main id="customer-profile">
        {% if not profile %}
            <section class="customer-empty">
                <p>目前找不到符合的會員資料{% if requested_member_id %}（查詢 ID：{{ requested_member_id }}）{% endif %}。</p>
                <p>請稍候再試，或上傳新照片以建立會員紀錄。</p>
            </section>
        {% else %}
        <div class="customer-layout">
            <article id="customer-information">
                <h2 class="hide">顧客資料</h2>
                <div class="customer-panel">
                    <figure class="customer-photo {% if not profile_image_url %}placeholder{% endif %}">
                        {% set fallback_photo = url_for('static', filename='images/face.jpg') %}
                        <img src="{{ profile_image_url or fallback_photo }}" alt="{{ display_name }} 的照片">
                    </figure>
                    <section class="customer-infolist">
                        <ul class="customer-basic-info">
                            <li class="customer-name">{{ display_name }}</li>
                            {% set membership_status = profile.member_status or '尚未提供' %}
                            <li class="customer-level {% if membership_status == '有效' %}general{% endif %}">{{ membership_status }}</li>
                            <li>Face ID：{{ profile.member_id or '尚未指派' }}</li>
                            <li>會員編號：{{ profile.mall_member_id or '尚未提供' }}</li>
                            <li>會員狀態：{{ membership_status }}</li>
                            <li>入會日期：{{ joined_at_display or profile.joined_at or '尚未提供' }}</li>
                            <li>點數餘額：
                                {% if points_balance_display %}
                                    {{ points_balance_display }} 點
                                {% elif profile.points_balance is not none %}
                                    {{ '%.0f'|format(profile.points_balance) }} 點
                                {% else %}
                                    尚未提供
                                {% endif %}
                            </li>
                        </ul>
                        <ul class="customer-contact-info">
                            <li>性別：{{ profile.gender or '尚未提供' }}</li>
                            <li>出生年月：{{ profile.birth_date or '未填寫' }}</li>
                            <li>聯絡電話：{{ profile.phone or '尚未提供' }}</li>
                            <li>電子郵件：{{ profile.email or '尚未提供' }}</li>
                            <li>郵遞地址：{{ profile.address or '未填寫' }}</li>
                            <li>職業 / 產業別：{{ profile.occupation or '未填寫' }}</li>
                        </ul>
                    </section>
                </div>
            </article>
            <article id="customer-details">
                <section id="customer-tags">
                    <h2>顧客標籤</h2>
                    <ul class="customer-taglist">
                        {% if customer_tags %}
                            {% for tag in customer_tags %}
                                <li>#{{ tag }}</li>
                            {% endfor %}
                        {% elif persona_label %}
                            <li>#{{ persona_label }}</li>
                        {% else %}
                            <li>#來店訪客</li>
                        {% endif %}
                    </ul>
                </section>
                <section id="customer-preferences">
                    <h2 class="hide">顧客偏好</h2>
                    <ul class="customer-preferencelist">
                        <!-- <li><span>偏好品牌</span>Adidas, New Balance</li> -->
                        <li>
                            <span>偏好商品類別</span>
                            <i>{{ preferred_category or '—' }}</i>
                        </li>
                        <li>
                            <span>最近消費時間</span>
                            {% if last_purchase_display %}
                                <i>{{ last_purchase_display }}</i>
                            {% else %}
                                <i>尚未有消費紀錄</i>
                            {% endif %}
                        </li>
                        <li>
                            <span>本季消費頻率</span>
                            <span>每月 <i>{{ seasonal_frequency }}</i> 次</span>
                        </li>
                        <li>
                            <span>平均消費金額</span>
                            {% if average_purchase_amount is not none %}
                                <span>NT$ <i>{{ '{:,.0f}'.format(average_purchase_amount) }}</i></span>
                            {% else %}
                                <span>NT$ <i>--</i></span>
                            {% endif %}
                        </li>
                    </ul>
                </section>
                <section id="customer-purchase-history">
                    <h2 class="hide">顧客購買歷史</h2>
                    <span id="tab-1">1</span>
                    <span id="tab-2">2</span>
                    <span id="tab-3">3</span>
                    <span id="tab-4">4</span>
                    <div id="tab">
                        <ul>
                            <li><a href="#tab-1" title="感興趣商品推估">感興趣商品推估</a></li>
                            <li><a href="#tab-2" title="歷史消費紀錄">歷史消費紀錄</a></li>
                            <li><a href="#tab-3" title="動線區域停留時間">動線區域停留時間</a></li>
                            <li><a href="#tab-4" title="參與活動紀錄">參與活動紀錄</a></li>
                        </ul>
                        <div class="tab-content-1">
                            <h3 class="hide">感興趣商品推估</h3>
                            <ul class="tool">
                                <li><a href="" class="search">搜尋</a></li>
                                <li><a href="" class="filter">篩選</a></li>
                            </ul>
                            <section class="prediction-results">
                                {% if prediction_window_label %}
                                <p class="prediction-window-label" id="prediction-window-label">參考期間：{{ prediction_window_label }}</p>
                                {% endif %}
                                <table aria-describedby="prediction-window-label">
                                    <thead>
                                        <tr>
                                            <th>商品編號</th>
                                            <th>商品名稱</th>
                                            <th>商品類別</th>
                                            <th>商品價格</th>
                                            <th>查閱率</th>
                                            <th>預估購買機率</th>
                                        </tr>
                                    </thead>
                                    <tbody id="prediction-table-body">
                                        {% if predicted_items %}
                                            {% for item in predicted_items %}
                                                {% set probability_class = 'hight' if item.probability_percent >= 85 else 'medium' if item.probability_percent >= 60 else '' %}
                                                {% set probability_text = '%.1f'|format(item.probability_percent) %}
                                                <tr data-prediction-row="true" data-index="{{ loop.index0 }}">
                                                    <td>{{ item.product_code }}</td>
                                                    <td>{{ item.product_name }}</td>
                                                    <td>{{ item.category_label }}</td>
                                                    <td>{{ '${:,.0f}'.format(item.price) }}</td>
                                                    <td>{{ '%.1f'|format(item.view_rate_percent) }}%</td>
                                                    <td>
                                                        {% if probability_class %}
                                                            <span class="{{ probability_class }}">{{ probability_text }}%</span>
                                                        {% else %}
                                                            {{ probability_text }}%
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        {% elif not is_new_guest %}
                                            <tr class="empty-message" data-empty-row="true">
                                                <td colspan="6">目前無可用的推薦商品。</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </section>
                        <div class="advertising">
                            <ul class="advertising_info">
                                <!-- <li><span>上傳速度</span>0.3秒</li>
                                <li><span>辨識速度</span>0.6秒</li>
                                <li><span>廣告生成</span>0.8秒</li>
                                <li><span>總計耗時</span>0.8秒</li> -->
                                {% set ad_link = resolved_member_id and 'http://34.80.216.88:8000/ad/' ~ resolved_member_id %}
                                <li class="btn">
                                    <a href="{{ ad_link or '#' }}" title="檢視生成廣告"{% if not ad_link %} aria-disabled="true" tabindex="-1"{% endif %}>檢視生成廣告</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="tab-content-2">
                        <h3 class="hide">歷史消費紀錄</h3>
                        <ul class="tool">
                            <li><a href="#" class="search" aria-disabled="true">搜尋</a></li>
                            <li><a href="#" class="filter" aria-disabled="true">篩選</a></li>
                        </ul>
                        {% set initial_month_key = selected_month_key %}
                        {% if initial_month_key is none and history_groups %}
                            {% set initial_month_key = history_groups[0]['key'] %}
                        {% endif %}
                        {% if selected_month_label %}
                            <div class="history-month-label" data-initial-label="{{ selected_month_label }}">{{ selected_month_label }}</div>
                        {% elif history_months %}
                            <div class="history-month-label" data-initial-label="{{ history_months[0]['label'] }}">{{ history_months[0]['label'] }}</div>
                        {% endif %}
                        {% if history_months %}
                            <ul class="page month-pagination" aria-label="歷史消費紀錄月份切換">
                                {% for month in history_months %}
                                    <li class="{% if month.page == page %}active{% endif %}">
                                        <a href="{{ url_for('dashboard', member_id=resolved_member_id, page=month.page) }}" title="{{ month.label }}" data-month="{{ month.key }}" data-label="{{ month.label }}">{{ month.label }}</a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        <table class="purchase-history">
                            <thead>
                                <tr>
                                    <th scope="col" class="datetime">消費日期時間</th>
                                    <th scope="col" class="item">項目</th>
                                    <th scope="col" class="category">商品類別</th>
                                    <th scope="col" class="numeric">單價</th>
                                    <th scope="col" class="numeric">數量</th>
                                    <th scope="col" class="numeric">總價</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if history_groups %}
                                    {% for group in history_groups %}
                                        {% for purchase in group.purchases %}
                                            {% set row_hidden = initial_month_key is not none and group.key != initial_month_key %}
                                            <tr data-month="{{ group.key }}"{% if row_hidden %} class="is-hidden"{% endif %}>
                                                <td class="datetime">{{ purchase.purchased_at }}</td>
                                                <td class="item">{{ purchase.item }}</td>
                                                <td class="category">{{ purchase.product_category or '—' }}</td>
                                                <td class="numeric">${{ '%.0f'|format(purchase.unit_price) }}</td>
                                                {% set qty_text = ('%.2f'|format(purchase.quantity)).rstrip('0').rstrip('.') %}
                                                <td class="numeric">{{ qty_text }}</td>
                                                <td class="numeric">${{ '%.0f'|format(purchase.total_price) }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endfor %}
                                {% elif not is_new_guest %}
                                    <tr>
                                        <td colspan="6" class="empty-message">尚未有消費紀錄。</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-content-3"><p>內容-3</p>
                    </div>
                    <div class="tab-content-4"><p>內容-4</p>
                    </div>
                </div>
            </section>
            
        </article>
        </div>
        {% endif %}
    </main>
    <!-- <footer>
        <p>2025 &copy;  你的專屬折扣
    </footer> -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const predictionRows = document.querySelectorAll('#prediction-table-body tr[data-prediction-row="true"]');
        if (predictionRows.length) {
            predictionRows.forEach(function (row, index) {
                row.style.display = index < 7 ? '' : 'none';
            });
        }

        const monthLinks = document.querySelectorAll('.month-pagination a[data-month]');
        const historyRows = document.querySelectorAll('.purchase-history tbody tr[data-month]');
        const monthLabel = document.querySelector('.history-month-label');

        if (!monthLinks.length || !historyRows.length) {
            return;
        }

        monthLinks.forEach(function (link) {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                const month = link.getAttribute('data-month');
                const label = link.getAttribute('data-label');
                if (!month) {
                    return;
                }
                historyRows.forEach(function (row) {
                    const matches = row.getAttribute('data-month') === month;
                    row.classList.toggle('is-hidden', !matches);
                });
                monthLinks.forEach(function (other) {
                    const parent = other.parentElement;
                    if (!parent) {
                        return;
                    }
                    parent.classList.toggle('active', other === link);
                });
                if (monthLabel && label) {
                    monthLabel.textContent = label;
                }
            });
        });
    });
    </script>
</body>
</html>
