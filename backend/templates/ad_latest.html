<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>你的專屬折扣</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer-board.css') }}">
  </head>
  <body>
    {% set payload = context or {} %}
    {% set profile = payload.get('profile', {}) %}
    {% set items = payload.get('predicted_candidates', []) %}
    {% set timings = payload.get('timings', {}) %}
    {% set predicted = payload.get('predicted', {}) %}
    {% set purchases = payload.get('purchases', []) %}
    {% set first_purchase = purchases[0] if purchases else None %}
    {% set template_images = {
        'ME0000': url_for('static', filename='images/ads/ME0000.jpg'),
        'ME0001': url_for('static', filename='images/ads/ME0001.jpg'),
        'ME0002': url_for('static', filename='images/ads/ME0002.jpg'),
        'ME0003': url_for('static', filename='images/ads/ME0003.jpg')
    } %}
    {% set template_id = payload.get('template_id') %}
    {% set hero_image = payload.get('hero_image_url') or template_images.get(template_id) %}
    {% set raw_cta = payload.get('cta_href') %}
    {% set initial_cta_href = raw_cta if raw_cta and not raw_cta.startswith('#') else payload.get('ad_url') %}

    <header>
        <h1>你的專屬折扣</h1>
        <nav>
            <ul id="nav-links">
                <li class="event"><a href="#" title="促銷活動">促銷活動</a></li>
                <li class="shop"><a href="#" title="店舖管理">店舖管理</a></li>
                <li class="product"><a href="#" title="商品管理">商品管理</a></li>
                <li class="payment"><a href="#" title="金流管理">金流管理</a></li>
                <li class="customer active"><a href="#" title="顧客資料">顧客資料</a></li>
            </ul>
        </nav>
    </header>
    <main id="customer-profile">
        <article id="customer-information">
            <h2 class="hide">顧客資料</h2>
            <figure class="customer-photo">
                <img id="customer-photo" src="{{ profile.get('photo_url') or url_for('static', filename='images/face.jpg') }}" alt="Customer Photo">
                <figcaption id="detected-at">{{ payload.get('detected_at', '--') }}</figcaption>
            </figure>
            <section class="customer-infolist">
                <ul class="customer-basic-info">
                    <li class="customer-name" id="customer-name">{{ profile.get('name') or '匿名顧客' }}</li>
                    <li class="customer-level general" id="member-status">{{ profile.get('member_status') or ('訪客' if payload.get('audience') == 'new' else '一般會員') }}</li>
                    <li>Face ID：<span id="face-id">{{ payload.get('member_id', '--') }}</span></li>
                    <li>會員編號：<span id="member-code">{{ profile.get('member_code') or '尚未註冊' }}</span></li>
                    <li>會員狀態：<span id="member-state">{{ profile.get('member_status') or '未知' }}</span></li>
                    <li>加入日期：<span id="joined-at">{{ profile.get('joined_at') or '--' }}</span></li>
                    <li>點數餘額：<span id="points-balance">{{ profile.get('points_balance', 0) }}</span> 點</li>
                </ul>
                <ul class="customer-contact-info">
                    <li>性別：<span id="member-gender">{{ profile.get('gender') or '未填寫' }}</span></li>
                    <li>出生年月：<span id="member-birth">{{ profile.get('birth_date') or '未填寫' }}</span></li>
                    <li>聯絡電話：<span id="member-phone">{{ profile.get('phone') or '未填寫' }}</span></li>
                    <li>電子郵件：<span id="member-email">{{ profile.get('email') or '未填寫' }}</span></li>
                    <li>郵遞地址：<span id="member-address">{{ profile.get('address') or '未填寫' }}</span></li>
                    <li>職業 / 產業別：<span id="member-occupation">{{ profile.get('occupation') or '未填寫' }}</span></li>
                </ul>
            </section>
        </article>
        <article id="customer-details">
            <section id="customer-tags">
                <h2>顧客標籤</h2>
                <ul class="customer-taglist" id="member-tags">
                    <li>#{{ profile.get('profile_label') or '來店訪客' }}</li>
                </ul>
            </section>
            <section id="customer-preferences">
                <h2 class="hide">顧客偏好</h2>
                <ul class="customer-preferencelist">
                    <li><span>偏好商品類別</span><span id="preference-category">{{ predicted.get('category_label') or predicted.get('category') or '健康飲品' }}</span></li>
                    <li><span>最近消費時間</span><i id="last-purchase">{{ first_purchase['purchased_at'] if first_purchase else '--' }}</i></li>
                    <li><span>本季消費頻率</span>每月 <i id="season-frequency">{{ purchases|length }}</i> 次</li>
                    <li><span>平均消費金額</span>NT$ <i id="avg-amount">{{ first_purchase['total_price']|int if first_purchase else 0 }}</i></li>
                </ul>
            </section>
            <section id="customer-purchase-history">
                <h2 class="hide">顧客購買歷史</h2>
                <span id="tab-1">1</span>
                <span id="tab-2">2</span>
                <span id="tab-3">3</span>
                <span id="tab-4">4</span>
                <div id="tab">
                    <ul>
                        <li><a href="#tab-1" title="感興趣商品推估">感興趣商品推估</a></li>
                        <li><a href="#tab-2" title="歷史消費紀錄">歷史消費紀錄</a></li>
                        <li><a href="#tab-3" title="動線區域停留時間">動線區域停留時間</a></li>
                        <li><a href="#tab-4" title="參與活動紀錄">參與活動紀錄</a></li>
                    </ul>
                    <div class="tab-content-1">
                        <h3 class="hide">感興趣商品推估</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>內部商品編號</th>
                                    <th>商品名稱</th>
                                    <th>商品類別</th>
                                    <th>商品價格</th>
                                    <th>商品<br/>查閱率</th>
                                    <th>廣告<br/>查閱率</th>
                                    <th>相似紀錄<br/>符合率</th>
                                    <th>預估購買機率</th>
                                </tr>
                            </thead>
                            <tbody id="prediction-rows">
                                {% for item in items[:7] %}
                                <tr>
                                    <td>{{ item.product_code or '--' }}</td>
                                    <td>{{ item.product_name or '--' }}</td>
                                    <td>{{ item.category_label or item.category or '--' }}</td>
                                    <td>{% if item.price is not none %}${{ '%.0f' % item.price }}{% else %}--{% endif %}</td>
                                    <td>{{ item.view_rate_percent or '65' }}%</td>
                                    <td>{{ item.get('ad_view_percent', '60') }}%</td>
                                    <td>{{ item.get('match_percent', '80') }}%</td>
                                    <td><span class="hight">高</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div class="advertising">
                            <ul class="advertising_info" id="timing-metrics">
                                <li><span>上傳速度</span><span id="timing-upload">{{ timings.get('upload', '--') }}</span>秒</li>
                                <li><span>辨識速度</span><span id="timing-recognition">{{ timings.get('recognition', '--') }}</span>秒</li>
                                <li><span>廣告生成</span><span id="timing-generation">{{ timings.get('generation', '--') }}</span>秒</li>
                                <li><span>總計耗時</span><span id="timing-total">{{ timings.get('total', '--') }}</span>秒</li>
                                <li class="btn"><a href="{{ initial_cta_href or '#' }}" id="cta-link"{% if initial_cta_href %} target="_blank" rel="noopener"{% else %} aria-disabled="true" class="is-disabled"{% endif %} title="開啟個人化廣告頁">{{ payload.get('cta_text', '檢視生成廣告') }}</a></li>
                            </ul>
                        </div>
                        <div class="member-offer" id="member-offer">
                            <div class="member-offer__visual">
                                <img id="ad-hero" src="{{ hero_image or url_for('static', filename='images/ads/ME0000.jpg') }}" alt="個人化優惠" loading="lazy" />
                            </div>
                            <div class="member-offer__copy">
                                <h3 id="ad-headline">{{ payload.get('headline') or '專屬優惠推薦' }}</h3>
                                <p class="subheading{% if not payload.get('subheading') %} is-hidden{% endif %}" id="ad-subheading"{% if not payload.get('subheading') %} aria-hidden="true"{% endif %}>{{ payload.get('subheading') or '' }}</p>
                                <p class="highlight{% if not payload.get('highlight') %} is-hidden{% endif %}" id="ad-highlight"{% if not payload.get('highlight') %} aria-hidden="true"{% endif %}>{{ payload.get('highlight') or '' }}</p>
                                <a class="cta-button{% if not initial_cta_href %} is-disabled{% endif %}" id="ad-cta" href="{{ initial_cta_href or '#' }}"{% if initial_cta_href %} target="_blank" rel="noopener"{% else %} aria-disabled="true"{% endif %}>{{ payload.get('cta_text') or '會員限定優惠立即領取' }}</a>
                            </div>
                        </div>

                        <ul class="page">
                            <li class="active"><a href="#" title="第1頁">1</a></li>
                            <li><a href="#" title="第2頁">2</a></li>
                            <li><a href="#" title="第3頁">3</a></li>
                        </ul>
                    </div>
                    <div class="tab-content-2">
                        <h3 class="hide">歷史消費紀錄</h3>
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>消費日期</th>
                                    <th>商品名稱</th>
                                    <th>數量</th>
                                    <th>總金額</th>
                                </tr>
                            </thead>
                            <tbody id="history-rows">
                                {% if purchases %}
                                    {% for purchase in purchases[:10] %}
                                    <tr>
                                        <td>{{ purchase.purchased_at or '--' }}</td>
                                        <td>{{ purchase.item or '--' }}</td>
                                        <td>{{ purchase.quantity or 0 }}</td>
                                        <td>{% if purchase.total_price is not none %}NT${{ '%.0f' % purchase.total_price }}{% else %}--{% endif %}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="4">尚無歷史消費紀錄。</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-content-3"><p>內容-3</p></div>
                    <div class="tab-content-4"><p>內容-4</p></div>
                </div>
            </section>
        </article>
    </main>
    <script>
      const templateImages = {
        'ME0000': '{{ url_for('static', filename='images/face.jpg') }}',
        'ME0001': '{{ url_for('static', filename='images/ads/ME0001.jpg') }}',
        'ME0002': '{{ url_for('static', filename='images/ads/ME0002.jpg') }}',
        'ME0003': '{{ url_for('static', filename='images/ads/ME0003.jpg') }}',
      };

      const offerImages = {
        'ME0000': '{{ url_for('static', filename='images/ads/ME0000.jpg') }}',
        'ME0001': '{{ url_for('static', filename='images/ads/ME0001.jpg') }}',
        'ME0002': '{{ url_for('static', filename='images/ads/ME0002.jpg') }}',
        'ME0003': '{{ url_for('static', filename='images/ads/ME0003.jpg') }}',
      };

      function formatProbabilityTag(probability) {
        if (typeof probability !== 'number') {
          return '<span class="medium">中</span>';
        }
        if (probability >= 66) {
          return '<span class="hight">高</span>';
        }
        if (probability >= 33) {
          return '<span class="medium">中</span>';
        }
        return '<span class="medium">中</span>';
      }

      function escapeHtml(value) {
        if (value === undefined || value === null) {
          return '--';
        }
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function buildRows(items) {
        if (!items || !items.length) {
          return '<tr><td colspan="8">暫無預測資料，歡迎加入會員以獲得更多推薦。</td></tr>';
        }
        return items.slice(0, 7).map((item) => {
          const price = item.price != null ? `$${Math.round(item.price)}` : '--';
          const category = item.category_label || item.category || '--';
          const viewRate = item.view_rate_percent != null ? `${item.view_rate_percent}%` : '65%';
          const adView = item.ad_view_percent != null ? `${item.ad_view_percent}%` : '60%';
          const matchRate = item.match_percent != null ? `${item.match_percent}%` : '80%';
          const probability = item.probability_percent;
          return `<tr>
            <td>${item.product_code || '--'}</td>
            <td>${item.product_name || '--'}</td>
            <td>${category}</td>
            <td>${price}</td>
            <td>${viewRate}</td>
            <td>${adView}</td>
            <td>${matchRate}</td>
            <td>${formatProbabilityTag(typeof probability === 'number' ? probability : null)}</td>
          </tr>`;
        }).join('');
      }

      function buildHistoryRows(purchases) {
        if (!purchases || !purchases.length) {
          return '<tr><td colspan="4">尚無歷史消費紀錄。</td></tr>';
        }
        return purchases.slice(0, 10).map((purchase) => {
          const date = escapeHtml(purchase.purchased_at || '--');
          const item = escapeHtml(purchase.item || '--');
          const quantity = purchase.quantity != null ? escapeHtml(purchase.quantity) : '0';
          const total = purchase.total_price != null ? `NT$${Math.round(purchase.total_price)}` : '--';
          return `<tr>
            <td>${date}</td>
            <td>${item}</td>
            <td>${quantity}</td>
            <td>${total}</td>
          </tr>`;
        }).join('');
      }

      function applyPayload(payload) {
        if (!payload) { return; }
        const profile = payload.profile || {};
        document.getElementById('customer-name').textContent = profile.name || '匿名顧客';
        document.getElementById('member-status').textContent = profile.member_status || (payload.audience === 'new' ? '訪客' : '一般會員');
        document.getElementById('face-id').textContent = payload.member_id || '--';
        document.getElementById('member-code').textContent = profile.member_code || '尚未註冊';
        document.getElementById('member-state').textContent = profile.member_status || '未知';
        document.getElementById('joined-at').textContent = profile.joined_at || '--';
        document.getElementById('points-balance').textContent = profile.points_balance != null ? profile.points_balance : 0;
        document.getElementById('member-gender').textContent = profile.gender || '未填寫';
        document.getElementById('member-birth').textContent = profile.birth_date || '未填寫';
        document.getElementById('member-phone').textContent = profile.phone || '未填寫';
        document.getElementById('member-email').textContent = profile.email || '未填寫';
        document.getElementById('member-address').textContent = profile.address || '未填寫';
        document.getElementById('member-occupation').textContent = profile.occupation || '未填寫';

        const photoEl = document.getElementById('customer-photo');
        const photoUrl = profile.photo_url || templateImages[payload.template_id] || templateImages.ME0000;
        if (photoEl && photoUrl) {
          photoEl.src = photoUrl;
        }

        document.getElementById('detected-at').textContent = payload.detected_at || '--';
        document.getElementById('member-tags').innerHTML = `<li>#${profile.profile_label || '來店訪客'}</li>`;

        const predicted = payload.predicted || {};
        document.getElementById('preference-category').textContent = predicted.category_label || predicted.category || '健康飲品';
        const purchases = payload.purchases || [];
        document.getElementById('last-purchase').textContent = purchases.length ? purchases[0].purchased_at : '--';
        document.getElementById('season-frequency').textContent = purchases.length;
        document.getElementById('avg-amount').textContent = purchases.length ? Math.round(purchases[0].total_price || 0) : 0;

        const tableBody = document.getElementById('prediction-rows');
        tableBody.innerHTML = buildRows(payload.predicted_candidates || []);
        document.getElementById('history-rows').innerHTML = buildHistoryRows(purchases);

        const timings = payload.timings || {};
        const getTiming = (key) => (timings[key] === undefined || timings[key] === null ? '--' : timings[key]);
        document.getElementById('timing-upload').textContent = getTiming('upload');
        document.getElementById('timing-recognition').textContent = getTiming('recognition');
        document.getElementById('timing-generation').textContent = getTiming('generation');
        document.getElementById('timing-total').textContent = getTiming('total');

        const preferredHref = payload.cta_href && !payload.cta_href.startsWith('#')
          ? payload.cta_href
          : payload.ad_url;

        function syncLink(linkEl, defaultText) {
          if (!linkEl) return;
          linkEl.textContent = payload.cta_text || defaultText;
          if (preferredHref) {
            linkEl.href = preferredHref;
            linkEl.target = '_blank';
            linkEl.rel = 'noopener';
            linkEl.classList.remove('is-disabled');
            linkEl.removeAttribute('aria-disabled');
          } else {
            linkEl.href = '#';
            linkEl.removeAttribute('target');
            linkEl.removeAttribute('rel');
            linkEl.classList.add('is-disabled');
            linkEl.setAttribute('aria-disabled', 'true');
          }
        }

        syncLink(document.getElementById('cta-link'), '檢視生成廣告');
        syncLink(document.getElementById('ad-cta'), '會員限定優惠立即領取');

        const heroEl = document.getElementById('ad-hero');
        if (heroEl) {
          const heroSrc = payload.hero_image_url || (payload.template_id && offerImages[payload.template_id]) || offerImages.ME0000;
          heroEl.src = heroSrc;
        }

        const headlineEl = document.getElementById('ad-headline');
        if (headlineEl) {
          headlineEl.textContent = payload.headline || '專屬優惠推薦';
        }

        const subheadingEl = document.getElementById('ad-subheading');
        if (subheadingEl) {
          if (payload.subheading) {
            subheadingEl.textContent = payload.subheading;
            subheadingEl.classList.remove('is-hidden');
            subheadingEl.removeAttribute('aria-hidden');
          } else {
            subheadingEl.textContent = '';
            subheadingEl.classList.add('is-hidden');
            subheadingEl.setAttribute('aria-hidden', 'true');
          }
        }

        const highlightEl = document.getElementById('ad-highlight');
        if (highlightEl) {
          if (payload.highlight) {
            highlightEl.textContent = payload.highlight;
            highlightEl.classList.remove('is-hidden');
            highlightEl.removeAttribute('aria-hidden');
          } else {
            highlightEl.textContent = '';
            highlightEl.classList.add('is-hidden');
            highlightEl.setAttribute('aria-hidden', 'true');
          }

        }
      }

      applyPayload({{ payload | tojson }});

      (function initStream() {
        if (!window.EventSource) {
          console.warn('EventSource not supported in this browser.');
          return;
        }
        const source = new EventSource('{{ stream_url }}');
        source.onmessage = (event) => {
          try {
            const payload = JSON.parse(event.data);
            applyPayload(payload);
          } catch (error) {
            console.error('Failed to apply payload', error);
          }
        };
      })();
    </script>
  </body>
</html>
