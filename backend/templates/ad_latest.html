<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>最新廣告即時看板</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ad-board.css') }}">
  </head>
  <body class="ad-board">
    {% set payload = context or {} %}
    {% set template_id = payload.template_id or 'ME0000' %}
    {% set hero_url = payload.hero_image_url or {{ url_for('static', filename='images/ads/ME0000.jpg') }} %}
    <article id="ad-card" class="ad-card {'{'} template_id {'}'}" style="background-image: url('{'{'} hero_url {'}'}');">
      <div class="copy" id="ad-copy">
        <p class="headline" id="ad-headline">{'{'} payload.headline or '' {'}'}</p>
        <p class="subheading" id="ad-subheading">{'{'} payload.subheading or '' {'}'}</p>
        <p class="highlight" id="ad-highlight">{'{'} payload.highlight or '' {'}'}</p>
      </div>
      <div class="cta" id="ad-cta" {'{'} '' if payload.cta_text else 'style="display:none"' {'}'}>
        <a href="{'{'} payload.cta_href or '#cta' {'}'}" id="ad-cta-link">{'{'} payload.cta_text or '' {'}'}</a>
      </div>
    </article>
    <script>
      const TEMPLATE_IMAGES = {
        'ME0000': '{{ url_for('static', filename='images/ads/ME0000.jpg') }}',
        'ME0001': '{{ url_for('static', filename='images/ads/ME0001.jpg') }}',
        'ME0002': '{{ url_for('static', filename='images/ads/ME0002.jpg') }}',
        'ME0003': '{{ url_for('static', filename='images/ads/ME0003.jpg') }}'
      };

      function resolveBackground(templateId, providedUrl) {
        if (providedUrl) {
          return providedUrl;
        }
        return TEMPLATE_IMAGES[templateId] || TEMPLATE_IMAGES.ME0000;
      }

      function applyAdPayload(data) {
        if (!data) {
          return;
        }
        const article = document.getElementById('ad-card');
        const copyBlock = document.getElementById('ad-copy');
        const headlineEl = document.getElementById('ad-headline');
        const subheadingEl = document.getElementById('ad-subheading');
        const highlightEl = document.getElementById('ad-highlight');
        const ctaWrapper = document.getElementById('ad-cta');
        const ctaLink = document.getElementById('ad-cta-link');

        const templateId = data.template_id || 'ME0000';
        const heroUrl = resolveBackground(templateId, data.hero_image_url);

        article.className = 'ad-card ' + templateId;
        article.style.backgroundImage = "url('" + heroUrl + "')";

        headlineEl.textContent = data.headline || '';
        subheadingEl.textContent = data.subheading || '';
        highlightEl.textContent = data.highlight || '';

        if (data.cta_text) {
          ctaLink.textContent = data.cta_text;
          ctaLink.href = data.cta_href || '#cta';
          ctaWrapper.style.display = 'block';
        } else {
          ctaWrapper.style.display = 'none';
        }
      }

      (function initStream() {
        if (!window.EventSource) {
          console.warn('EventSource not supported in this browser.');
          return;
        }
        const source = new EventSource('{'{'} stream_url {'}'}');
        source.onmessage = (event) => {
          try {
            const payload = JSON.parse(event.data);
            applyAdPayload(payload);
          } catch (error) {
            console.error('Failed to apply ad payload', error);
          }
        };
      })();
    </script>
  </body>
</html>
