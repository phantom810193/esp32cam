<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>你的專屬折扣</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manager.css') }}">
  </head>
  <body>
    <header>
      <h1>你的專屬折扣</h1>
      <nav>
        <ul id="nav-links">
          <li class="event"><a href="#" title="促銷活動">促銷活動</a></li>
          <li class="shop"><a href="#" title="店舖管理">店舖管理</a></li>
          <li class="product"><a href="#" title="商品管理">商品管理</a></li>
          <li class="payment"><a href="#" title="金流管理">金流管理</a></li>
          <li class="customer active"><a href="#" title="顧客資料">顧客資料</a></li>
        </ul>
      </nav>
    </header>

    <main id="customer-profile">
      <!-- 左側：照片 + 會員欄 -->
      <article id="customer-information">
        <h2 class="hide">顧客資料</h2>

        <figure class="customer-photo">
          {% set hero = (context.hero_image_url if context and context.hero_image_url else url_for('static', filename='images/face.jpg')) %}
          <img src="{{ hero }}" alt="Customer Photo" loading="lazy">

          <!-- 照片左上角：上傳辨識 / ESP32-CAM -->
          <div class="photo-actions">
            <form class="photo-upload" method="post" enctype="multipart/form-data">
              <input id="image" name="image" type="file" accept="image/*" onchange="this.form.submit()">
              <label for="image" class="btn-solid" title="上傳圖片辨識">上傳辨識</label>
              <a class="btn-ghost" href="{{ url_for('manager_dashboard_view', member_id=request.args.get('member_id')) }}">ESP32-CAM</a>
            </form>
          </div>
        </figure>

        <section class="customer-infolist">
          {% set m = context.member if context and context.member else None %}
          <ul class="customer-basic-info">
            <li class="customer-name">{{ (m.name if m and m.name else '王小美') }}</li>
            <li class="customer-level">{{ (m.member_level if m and m.member_level else '一般會員') }}</li>
            <li>Face ID：{{ context.member_code if context and context.member_code else 'ME0001' }}</li>
            <li>會員編號：{{ (m.mall_member_id if m and m.mall_member_id else (context.member_id if context else 'MEME0383FE3AA')) }}</li>
            <li>會員狀態：{{ m.member_status if m and m.member_status else '有效' }}</li>
            <li>入會日期：{{ m.joined_at if m and m.joined_at else '2021-06-12' }}</li>
            <li>點數餘額：{{ '%.0f'|format(m.points_balance) if m and m.points_balance is not none else '1,2840 點' }}</li>
          </ul>
          <ul class="customer-contact-info">
            <li>性別：{{ m.gender if m and m.gender else '女性' }}</li>
            <li>出生年月：{{ m.birth if m and m.birth else '未填寫' }}</li>
            <li>聯絡電話：{{ m.phone if m and m.phone else '0912-345678' }}</li>
            <li>電子郵件：{{ m.email if m and m.email else 'mingming@example.com' }}</li>
            <li>郵遞地址：{{ m.address if m and m.address else '台北市信義區松壽路10號' }}</li>
            <li>職業 / 產業別：{{ m.occupation if m and m.occupation else '甜點教室講師' }}</li>
          </ul>
        </section>
      </article>

      <!-- 右側：標籤、摘要、表格 -->
      <article id="customer-details">
        <section id="customer-tags">
          <h2>顧客標籤</h2>
          <ul class="customer-taglist">
            {% if context and context.tags %}
              {% for t in context.tags %}<li>#{{ t }}</li>{% endfor %}
            {% else %}
              <li>#甜點收藏家</li><li>#健身族群</li><li>#保健食品</li><li>#蛋白粉</li><li>#水果</li><li>#美妝愛好</li>
            {% endif %}
          </ul>
        </section>

        <section id="customer-preferences">
          <h2 class="hide">顧客偏好</h2>
          <ul class="customer-preferencelist">
            <li><span>偏好商品類別</span>{{ context.pref_category or '穀物 / 早餐、健康飲品' }}</li>
            <li><span>最近消費時間</span><i>{{ context.last_spent_when or '2天前' }}</i> {{ context.last_spent_date or '2025/09/25' }}</li>
            <li><span>本季消費頻率</span>每月 <i>{{ context.spend_freq or '4' }}</i>次</li>
            <li><span>平均消費金額</span>NT$ <i>{{ context.avg_spend or '8,320' }}</i></li>
          </ul>
        </section>

        <section id="customer-purchase-history">
          <h2 class="hide">顧客購買歷史</h2>

          <!-- tab anchors（符合你的 CSS） -->
          <span id="tab-1">1</span><span id="tab-2">2</span><span id="tab-3">3</span><span id="tab-4">4</span>

          <div id="tab">
            <ul>
              <li><a href="#tab-1" title="感興趣商品推估">感興趣商品推估</a></li>
              <li><a href="#tab-2" title="歷史消費紀錄">歷史消費紀錄</a></li>
              <li><a href="#tab-3" title="動線區域停留時間">動線區域停留時間</a></li>
              <li><a href="#tab-4" title="參與活動紀錄">參與活動紀錄</a></li>
            </ul>

            <div class="tab-content-1">
              <h3 class="hide">感興趣商品推估</h3>
              <ul class="tool">
                <li><a href="#" class="search">搜尋</a></li>
                <li><a href="#" class="filter">篩選</a></li>
              </ul>

              <table>
                <thead>
                  <tr>
                    <th>內部商品編號</th>
                    <th>商品名稱</th>
                    <th>商品類別</th>
                    <th>商品價格</th>
                    <th>商品<br/>查閱率</th>
                    <th>預估購買機率</th>
                  </tr>
                </thead>
                <tbody>
                  {% if context and context.prediction and context.prediction.items %}
                    {% for it in context.prediction.items %}
                      <tr>
                        <td>{{ it.product_code }}</td>
                        <td>{{ it.product_name }}</td>
                        <td>{{ it.category_label }}</td>
                        <td>NT$ {{ '%.0f'|format(it.price) }}</td>
                        <td>{{ '%.0f'|format(it.view_rate_percent) }}%</td>
                        <td>
                          <span class="{{ 'hight' if it.probability_percent|float >= 75 else 'medium' }}">
                            {{ '%.0f'|format(it.probability_percent) }}%
                          </span>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <!-- 沒資料就顯示樣板行（跟設計圖一樣） -->
                    <tr><td>100234</td><td>桂花牌有機澳洲燕麥片 500g</td><td>穀物 / 早餐</td><td>$250</td><td>85%</td><td><span class="hight">96%</span></td></tr>
                    <tr><td>204233</td><td>Light 能量蛋白棒 | 醇濃巧克力</td><td>健康飲品</td><td>$260</td><td>80%</td><td><span class="hight">92%</span></td></tr>
                    <tr><td>401022</td><td>冷壓綜合果汁 350ml</td><td>健康飲品</td><td>$95</td><td>75%</td><td><span class="hight">80%</span></td></tr>
                    <tr><td>305120</td><td>瑜伽墊止滑清潔噴霧</td><td>運動配件</td><td>$240</td><td>75%</td><td><span class="medium">70%</span></td></tr>
                    <tr><td>401022</td><td>無糖優格 200ml</td><td>健康飲品</td><td>$250</td><td>75%</td><td><span class="medium">68%</span></td></tr>
                    <tr><td>823144</td><td>冷壓蘋果果汁 350ml</td><td>健康飲品</td><td>$95</td><td>75%</td><td><span class="medium">67%</span></td></tr>
                    <tr><td>621412</td><td>橡膠啞鈴 14kg</td><td>運動配件</td><td>$395</td><td>72%</td><td><span class="medium">66%</span></td></tr>
                  {% endif %}
                </tbody>
              </table>

              <div class="advertising">
                <ul class="advertising_info">
                  <li class="btn">
                    <a href="{{ url_for('ad_image', member_id=(context.member_id if context else request.args.get('member_id'))) }}"
                       title="檢視生成廣告" target="_blank" rel="noopener">檢視生成廣告</a>
                  </li>
                </ul>
              </div>

              <ul class="page">
                <li class="active"><a href="#" title="第1頁">1</a></li>
                <li><a href="#" title="第2頁">2</a></li>
                <li><a href="#" title="第3頁">3</a></li>
              </ul>
            </div>

            <div class="tab-content-2"><p>尚無上一個月的消費資料</p></div>
            <div class="tab-content-3"><p>尚無動線資料</p></div>
            <div class="tab-content-4"><p>尚無參與活動紀錄</p></div>
          </div>
        </section>
      </article>
    </main>

    <!-- 針對照片上兩顆按鈕的小樣式補強（不動你的主 CSS） -->
    <style>
      .photo-actions{position:absolute;top:12px;left:12px;display:flex;gap:8px;z-index:3}
      .photo-actions input[type=file]{display:none}
      .btn-solid,.btn-ghost{display:inline-block;padding:8px 12px;border-radius:10px;font-size:.9em;text-decoration:none;cursor:pointer}
      .btn-solid{background:#1B6F15;color:#fff}
      .btn-ghost{background:rgba(255,255,255,.92);color:#1B6F15;border:1px solid #1B6F15}
      .btn-ghost:hover{background:#1B6F15;color:#fff}
    </style>
  </body>
</html>
