<!-- backend/templates/manager.html -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>智慧廣告管理後台</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/manager.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="manager-shell">
  <!-- 頂部：標題 + 兩顆按鈕（上傳／ESP32-CAM） -->
  <header class="manager-header">
    <h1>你的專屬折扣</h1>
    <nav class="nav-actions">
      <button id="btn-upload" class="btn">上傳照片</button>
      <input id="file-input" type="file" accept="image/*" class="hide" />
      <button id="btn-esp32" class="btn secondary">ESP32-CAM 拍照</button>
    </nav>
  </header>

  <!-- 主格局（固定版面：左 560px × 上 260px） -->
  <main class="grid-wrap">
    <!-- 左上：廣告／人物照片 -->
    <section class="panel banner">
      {% set default_banner = url_for('static', filename='ads/ME0000.jpg') if 'static' in globals() else '/static/ads/ME0000.jpg' %}
      <img id="banner" src="{{ context.hero_image_url if context and context.hero_image_url else default_banner }}" alt="廣告" />
      <div class="banner-badges">
        <span class="chip">上傳辨識</span>
        <span class="chip">ESP32-CAM</span>
      </div>
    </section>

    <!-- 右上：四張資訊卡 -->
    <section class="panel kpis">
      <div class="kpi">最近來店時間<div id="kpi-last-visit" class="kpi-v">—</div></div>
      <div class="kpi">本月消費頻率<div id="kpi-freq" class="kpi-v">—</div></div>
      <div class="kpi">平均消費金額<div id="kpi-avg" class="kpi-v">—</div></div>
      <div class="kpi">會員等級<div id="kpi-level" class="kpi-v">—</div></div>
    </section>

    <!-- 左下：會員區塊 -->
    <section class="panel member">
      {% set member_profile = context.member if context else None %}
      {% set display_mid = (member_profile.mall_member_id if member_profile and member_profile.mall_member_id else (member_profile.member_id if member_profile and member_profile.member_id else (context.member_id if context else 'ME0000'))) %}
      <h2 id="mid">{{ display_mid }}</h2>
      <ul class="meta">
        <li>Face ID：<span id="faceid">{{ member_profile.face_id if member_profile and member_profile.face_id else '—' }}</span></li>
        <li>會員狀態：<span id="mstatus">{{ member_profile.member_status if member_profile else '—' }}</span></li>
        <li>入會日期：<span id="mjoin">{{ member_profile.joined_at if member_profile else '—' }}</span></li>
        <li>點數餘額：<span id="mpoint">{{ ('%.0f'|format(member_profile.points_balance)) if member_profile and member_profile.points_balance is not none else '—' }}</span></li>
        <li>性別：<span id="mgender">{{ member_profile.gender if member_profile else '—' }}</span></li>
        <li>出生年月：<span id="mdob">{{ member_profile.birth_month if member_profile else '—' }}</span></li>
        <li>聯絡電話：<span id="mphone">{{ member_profile.phone if member_profile else '—' }}</span></li>
        <li>電子郵件：<span id="memail">{{ member_profile.email if member_profile else '—' }}</span></li>
        <li>郵遞地址：<span id="maddr">{{ member_profile.address if member_profile else '—' }}</span></li>
        <li>職業／產業別：<span id="mjob">{{ member_profile.occupation if member_profile else '—' }}</span></li>
      </ul>
      <button id="btn-main-ad" class="btn solid" onclick="if(window.currentMID){window.open('/ad/'+encodeURIComponent(window.currentMID),'_blank');}">檢視主視覺廣告</button>
    </section>

    <!-- 右下：兩個表格（推估 / 歷史） -->
    <section class="panel tables">
      <div class="tabs">
        <button class="tab active" data-tab="pred">感興趣商品推估</button>
        <button class="tab" data-tab="hist">歷史消費紀錄</button>
      </div>

      <div id="tab-pred" class="tabpane active">
        <table class="tbl">
          <thead><tr>
            <th>內部商品編號</th><th>商品名稱</th><th>商品類別</th>
            <th>商品價格</th><th>商品查閱率</th><th>預估購買機率</th>
          </tr></thead>
          <tbody id="pred-body">
            {% if context and context.prediction and context.prediction.items %}
              {% for item in context.prediction.items %}
              <tr>
                <td>{{ item.product_code }}</td>
                <td class="ell">{{ item.product_name }}</td>
                <td>{{ item.category_label }}</td>
                <td>NT$ {{ '%.0f'|format(item.price) }}</td>
                <td>{{ '%.1f'|format(item.view_rate_percent) }}%</td>
                <td><span class="pill">{{ '%.1f'|format(item.probability_percent) }}%</span></td>
              </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>

      <div id="tab-hist" class="tabpane">
        <table class="tbl">
          <thead><tr>
            <th>日期</th><th>商品編號</th><th>商品名稱</th><th>商品類別</th>
            <th>單價</th><th>數量</th><th>小計</th>
          </tr></thead>
          <tbody id="hist-body">
            {% if context and context.prediction and context.prediction.history %}
              {% for p in context.prediction.history %}
              <tr>
                <td>{{ p.purchased_at[:10] if p.purchased_at }}</td>
                <td>{{ p.sku or '' }}</td>
                <td class="ell">{{ p.item }}</td>
                <td>{{ p.category }}</td>
                <td>NT$ {{ '%.0f'|format(p.unit_price) }}</td>
                <td>{{ '%.0f'|format(p.quantity) }}</td>
                <td>NT$ {{ '%.0f'|format(p.total_price) }}</td>
              </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<script>
/* ===== 固定 API 位址 ===== */
const API = {
  identify: "/identify",
  pred: (mid)=>`/members/${encodeURIComponent(mid)}/predictions`,
  hist: (mid)=>`/members/${encodeURIComponent(mid)}/history`,
  adgen: "/adgen"
};

/* ===== 工具 ===== */
const $ = (s)=>document.querySelector(s);
function fmtPct(x){ return (Number(x)||0).toFixed(1) + "%"; }
function fmtCur(x){ return "NT$ " + (Number(x)||0).toLocaleString(); }

/* ===== 狀態 ===== */
window.currentMID = "{{ display_mid if display_mid else 'ME0000' }}";

/* ===== 切換分頁 ===== */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tabpane").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.querySelector("#tab-"+btn.dataset.tab).classList.add("active");
  });
});

/* ===== 呼叫後端 ===== */
async function loadPred(mid){
  try{
    const r = await fetch(API.pred(mid));
    const j = await r.json();
    $("#kpi-level").textContent = j.member_level || "—";
    const tb = $("#pred-body"); tb.innerHTML="";
    (j.rows||[]).forEach(o=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${o.sku}</td>
        <td class="ell">${o.name||""}</td>
        <td>${o.category||""}</td>
        <td>${fmtCur(o.price)}</td>
        <td>${fmtPct(o.view_rate)}</td>
        <td><span class="pill">${fmtPct(o.probability_percent)}</span></td>`;
      tb.appendChild(tr);
    });
    // 取機率最高的一筆打 /adgen 更新 Banner
    if ((j.rows||[]).length){
      const top = j.rows[0];
      const body = {sku: top.sku, member_profile:{membership: j.member_level||"general", top_pick_name: top.name, top_pick_price: "NT$ "+top.price}};
      const a = await fetch(API.adgen,{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const ad = await a.json();
      if (ad.image_url) $("#banner").src = ad.image_url;
      $("#kpi-freq").textContent = "—";
      $("#kpi-avg").textContent = "—";
      $("#kpi-last-visit").textContent = "—";
    }
  }catch(e){ console.error(e); }
}
async function loadHist(mid){
  try{
    const r = await fetch(API.hist(mid));
    const j = await r.json();
    const tb = $("#hist-body"); tb.innerHTML="";
    (j.rows||[]).forEach(o=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${(o.purchased_at||"").substring(0,10)}</td>
        <td>${o.sku||""}</td>
        <td class="ell">${o.name||o.item||""}</td>
        <td>${o.category||""}</td>
        <td>${fmtCur(o.price||o.unit_price)}</td>
        <td>${o.quantity||1}</td>
        <td>${fmtCur(o.total_price||0)}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}
async function identifyByUpload(file){
  const fd = new FormData(); fd.append("file", file);
  const r = await fetch(API.identify,{method:"POST", body:fd});
  const j = await r.json();
  return j.member_id || "ME0000";
}

/* ===== 事件：上傳／ESP32-CAM ===== */
$("#btn-upload").addEventListener("click",()=>$("#file-input").click());
$("#file-input").addEventListener("change", async e=>{
  if (!e.target.files.length) return;
  const mid = await identifyByUpload(e.target.files[0]);
  window.currentMID = mid;
  $("#mid").textContent = mid;
  $("#mstatus").textContent = (mid==="ME0000"?"新顧客/未入會":"已入會");
  await loadPred(mid);
  await loadHist(mid);
});

$("#btn-esp32").addEventListener("click", async ()=>{
  // 這裡預留：若你有 VM 的即時拍照 API，可改成 fetch 該端點
  // 目前用 identify JSON 直傳來觸發流程
  const r = await fetch(API.identify,{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({member_id: window.currentMID})});
  await loadPred(window.currentMID);
  await loadHist(window.currentMID);
});

/* ===== 初始載入（若模板已有 context，依然會再補齊資料） ===== */
loadPred(window.currentMID);
loadHist(window.currentMID);
</script>
</body>
</html>
