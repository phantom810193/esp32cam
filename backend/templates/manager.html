<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>智慧廣告管理後台</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manager.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <header class="topbar">
      <div class="topbar__left">
        <h1 class="brand">ESP32-CAM 智慧廣告中控台</h1>
        <p class="brand-sub">依據上一期消費紀錄推估本月潛在清單與專屬廣告</p>
      </div>
      <div class="topbar__right">
        <button id="btn-upload" class="btn btn-primary">上傳照片</button>
        <button id="btn-camera" class="btn btn-ghost">ESP32-CAM 拍照</button>
        <form id="memberPicker" class="member-picker" method="get">
          <label for="member_id" class="sr-only">選擇顧客</label>
          <select id="member_id" name="member_id" onchange="this.form.submit()">
            {% if members %}
              {% for profile in members %}
                <option value="{{ profile.member_id }}" {% if context and profile.member_id == context.member_id %}selected{% elif not context and profile.member_id == request.args.get('member_id') %}selected{% endif %}>
                  {{ profile.mall_member_id or profile.member_id }} · {{ profile.profile_label|replace('-', ' ') }}
                </option>
              {% endfor %}
            {% else %}
              <option value="" selected>尚無會員資料</option>
            {% endif %}
          </select>
          <noscript><button type="submit" class="btn">載入</button></noscript>
        </form>
      </div>
      <!-- 隱藏檔案選擇 -->
      <input id="file-input" class="sr-only" type="file" accept="image/*">
    </header>

    {% if error %}
      <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    <main class="grid">
      <!-- Hero -->
      <section class="card card-hero">
        <div class="hero-left">
          <div class="hero-image">
            {% if context and context.hero_image_url %}
              <img src="{{ context.hero_image_url }}" alt="顧客影像" loading="lazy">
            {% else %}
              <div class="hero-placeholder">等待上傳 ESP32-CAM 圖像</div>
            {% endif %}
          </div>
        </div>
        <div class="hero-right">
          {% if context %}
            {% set member_profile = context.member %}
            {% set display_name = member_profile.mall_member_id if member_profile and member_profile.mall_member_id else (member_profile.member_id if member_profile and member_profile.member_id else context.member_id) %}
            <div class="hero-meta">
              <span class="chip">情境：{{ context.scenario_key }}</span>
              <span class="chip">分析區間：{{ context.prediction.window_label }}</span>
            </div>
            <h2 class="hero-title">{{ display_name or '未知顧客' }}</h2>
            <p class="hero-sub">{{ member_profile.profile_label|replace('-', ' ') if member_profile else '尚未辨識' }}</p>
            <dl class="hero-stats">
              <div>
                <dt>核心主打</dt>
                <dd>{{ context.analysis.recommended_item or '等待歷史累積' }}</dd>
              </div>
              <div>
                <dt>預估轉換率</dt>
                <dd>{{ context.analysis.probability_percent }}%</dd>
              </div>
              <div>
                <dt>歷史訂單數</dt>
                <dd>{{ context.analysis.total_purchases }}</dd>
              </div>
            </dl>
            <div class="hero-actions">
              <a class="btn btn-primary" href="{{ context.ad_url }}" target="_blank" rel="noopener">檢視主視覺廣告</a>
            </div>
          {% else %}
            <div class="hero-empty">請先選擇顧客或上傳照片，即可載入預測資訊</div>
          {% endif %}
        </div>
      </section>

      <!-- 四格 KPI -->
      <section class="card kpi">
        <h4>最近來店時間</h4>
        <p>—</p>
      </section>
      <section class="card kpi">
        <h4>本月消費頻率</h4>
        <p>—</p>
      </section>
      <section class="card kpi">
        <h4>平均消費金額</h4>
        <p>—</p>
      </section>
      <section class="card kpi">
        <h4>會員等級</h4>
        <p>—</p>
      </section>

      <!-- 會員資料 -->
      <section class="card span-6">
        <h3>會員資料</h3>
        {% if context and context.member %}
          <dl class="info-grid">
            <div>
              <dt>會員編號</dt><dd>{{ context.member.mall_member_id or '尚未加入會員' }}</dd>
            </div>
            <div>
              <dt>會員狀態</dt><dd>{{ context.member.member_status }}</dd>
            </div>
            <div>
              <dt>加入日期</dt><dd>{{ context.member.joined_at }}</dd>
            </div>
            <div>
              <dt>職業 / 產業別</dt><dd>{{ context.member.occupation or '—' }}</dd>
            </div>
            <div>
              <dt>聯絡電話</dt><dd>{{ context.member.phone }}</dd>
            </div>
            <div>
              <dt>電子郵件</dt><dd>{{ context.member.email }}</dd>
            </div>
            <div>
              <dt>郵遞地址</dt><dd>{{ context.member.address or '—' }}</dd>
            </div>
            <div>
              <dt>點數餘額</dt><dd>{{ '%.0f'|format(context.member.points_balance) }}</dd>
            </div>
          </dl>
        {% else %}
          <p class="empty">尚無會員資料</p>
        {% endif %}
      </section>

      <!-- 潛在熱銷清單 -->
      <section class="card span-6">
        <header class="section-head">
          <div>
            <h3>本月潛在熱銷清單</h3>
            <p class="muted">依據上一個月的消費紀錄推估尚未購買的商品（七筆），並計算購買機率</p>
          </div>
          {% if context %}
            <span class="chip chip-accent">分析窗口：{{ context.prediction.window_label }}</span>
          {% endif %}
        </header>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>商品編號</th>
                <th>商品名稱</th>
                <th>商品類別</th>
                <th>商品價格</th>
                <th>商品查閱率</th>
                <th>預估購買機率</th>
              </tr>
            </thead>
            <tbody>
              {% if context and context.prediction.items %}
                {% for item in context.prediction.items %}
                  <tr>
                    <td>{{ item.product_code }}</td>
                    <td>{{ item.product_name }}</td>
                    <td>{{ item.category_label }}</td>
                    <td>NT$ {{ '%.0f'|format(item.price) }}</td>
                    <td>{{ '%.1f'|format(item.view_rate_percent) }}%</td>
                    <td>{{ '%.1f'|format(item.probability_percent) }}%</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="6" class="empty">尚無可用預測資料</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        {% if context and context.prediction.top_products %}
          <div class="top-products">
            <h4>上一期熱銷前三名</h4>
            <ul>
              {% for product in context.prediction.top_products %}
                <li>
                  <strong>{{ product.item }}</strong>
                  <span>數量 {{ product.quantity }}</span>
                  <span>金額 NT$ {{ '%.0f'|format(product.total_price) }}</span>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </section>

      <!-- 歷史紀錄 -->
      <section class="card span-12">
        <header class="section-head">
          <h3>上一個月消費紀錄</h3>
          {% if context %}<span class="muted">{{ context.prediction.window_label }}</span>{% endif %}
        </header>
        {% if context and context.prediction.history %}
          <ul class="history-list">
            {% for purchase in context.prediction.history %}
              <li>
                <div>
                  <strong>{{ purchase.item }}</strong>
                  <span>數量 {{ '%.0f'|format(purchase.quantity) }} · 單價 NT$ {{ '%.0f'|format(purchase.unit_price) }}</span>
                </div>
                <time>{{ purchase.purchased_at }}</time>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="empty">尚無上一個月的消費資料</p>
        {% endif %}
      </section>
    </main>

    <!-- Toast/Spinner -->
    <div id="toast" class="toast" hidden>
      <div class="spinner"></div>
      <span id="toast-text">上傳中…</span>
    </div>

    <script>
      const $ = (sel) => document.querySelector(sel);
      const btnUpload = $('#btn-upload');
      const btnCam = $('#btn-camera');
      const input = $('#file-input');
      const toast = $('#toast');
      const toastText = $('#toast-text');

      function showToast(text) {
        toastText.textContent = text || '處理中…';
        toast.hidden = false;
      }
      function hideToast() {
        toast.hidden = true;
      }
      async function postUpload(file) {
        const fd = new FormData();
        fd.append('image', file, file.name);
        showToast('上傳中…');
        try {
          const res = await fetch('{{ url_for("upload_face") }}', { method: 'POST', body: fd });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          hideToast();
          if (data && (data.member_id || data.member_code)) {
            const mid = data.member_id || '';
            // 導向當前後台頁，並帶上 member_id；同時可在背景開啟顧客版廣告
            if (data.ad_url) { try { window.open(data.ad_url, '_blank'); } catch (e) {} }
            const url = new URL(location.href);
            url.searchParams.set('member_id', mid);
            location.href = url.toString();
          } else {
            alert('上傳成功但未取得 member_id，請檢查後端日誌。');
          }
        } catch (err) {
          hideToast();
          alert('上傳失敗：' + (err && err.message ? err.message : err));
        }
      }

      btnUpload?.addEventListener('click', () => input.click());
      input?.addEventListener('change', () => {
        const file = input.files && input.files[0];
        if (file) postUpload(file);
        input.value = '';
      });

      // 預留：若你有拍照 API，可在這裡呼叫
      btnCam?.addEventListener('click', async () => {
        alert('請接上 ESP32-CAM 拍照 API 後於此處呼叫，再回傳影像至 /upload_face。');
      });
    </script>
  </body>
</html>
