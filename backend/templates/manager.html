<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>你的專屬折扣</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manager.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="manager-shell">

      <!-- 上方廣告 Banner -->
      <section class="hero-banner">
        <div class="banner-left">
          {% if context and context.ad_image_url %}
            <img src="{{ context.ad_image_url }}" alt="廣告圖" class="ad-image">
          {% else %}
            <div class="hero-placeholder">等待 ESP32-CAM 上傳廣告圖</div>
          {% endif %}
        </div>
        <div class="banner-right">
          <button class="btn-upload">上傳辨識</button>
          <button class="btn-device">ESP32-CAM</button>
        </div>
      </section>

      <!-- 顧客資料 + 標籤 -->
      <section class="member-overview">
        <h2>{{ context.member.mall_member_id or '未加入會員' }}</h2>
        <span class="member-tag">
          {% if context.member_status == 'registered' %}一般會員{% else %}新顧客{% endif %}
        </span>
        <p>Face ID：{{ context.member.face_id or '—' }}</p>
        <p>會員編號：{{ context.member.mall_member_id or context.member.member_id }}</p>
        <p>會員狀態：
          {% if context.member_status == 'new' %}新顧客
          {% elif context.member_status == 'unregistered' %}未註冊會員
          {% else %}有效{% endif %}
        </p>
        <p>入會日期：{{ context.member.joined_at or '—' }}</p>
        <p>點數餘額：{{ context.member.points_balance or '—' }} 點</p>
        <p>性別：{{ context.member.gender or '—' }}</p>
        <p>出生年月：{{ context.member.birthdate or '未填寫' }}</p>
        <p>聯絡電話：{{ context.member.phone or '—' }}</p>
        <p>電子郵件：{{ context.member.email or '—' }}</p>
        <p>郵遞地址：{{ context.member.address or '—' }}</p>
        <p>職業 / 產業別：{{ context.member.occupation or '—' }}</p>
      </section>

      <!-- 興趣標籤 -->
      <section class="member-tags">
        {% if context and context.analysis and context.analysis.interests %}
          {% for tag in context.analysis.interests %}
            <span class="tag">#{{ tag }}</span>
          {% endfor %}
        {% else %}
          <span class="tag">#尚無標籤</span>
        {% endif %}
      </section>

      <!-- 消費摘要 -->
      <section class="member-summary">
        <div class="summary-item">
          <h4>最近消費時間</h4>
          <p>{{ context.analysis.last_purchase_at or '—' }}</p>
        </div>
        <div class="summary-item">
          <h4>本季消費頻率</h4>
          <p>{{ context.analysis.freq or '—' }} 每月</p>
        </div>
        <div class="summary-item">
          <h4>平均消費金額</h4>
          <p>NT$ {{ context.analysis.avg_spend or '0' }}</p>
        </div>
      </section>

      <!-- 商品推薦 / 歷史紀錄表 -->
      <section class="history-table">
        <header>
          <h3>歷史消費紀錄</h3>
        </header>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>內部商品編號</th>
                <th>商品名稱</th>
                <th>商品類別</th>
                <th>商品價格</th>
                <th>商品查閱率</th>
                <th>預估購買機率</th>
              </tr>
            </thead>
            <tbody>
              {% if context and context.prediction and context.prediction.items %}
                {% for item in context.prediction.items %}
                  <tr>
                    <td>{{ item.product_code }}</td>
                    <td>{{ item.product_name }}</td>
                    <td>{{ item.category_label }}</td>
                    <td>NT$ {{ '%.0f'|format(item.price) }}</td>
                    <td>{{ '%.2f'|format(item.view_rate_percent) }}%</td>
                    <td><strong>{{ '%.2f'|format(item.probability_percent) }}%</strong></td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="6" class="empty">尚無消費紀錄</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>

    </div>
  </body>
</html>
