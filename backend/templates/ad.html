<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>你的專屬折扣</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer-board.css') }}">
</head>
{% set profile = profile or context.profile or {} %}
{% set items = prediction_items or context.predicted_candidates or [] %}
{% set timings = timings or context.timings or {} %}
{% set purchases = purchases or context.purchases or [] %}
{% set predicted = context.predicted or {} %}
{% set first_purchase = purchases[0] if purchases else None %}
{% set ad_url = url_for('render_ad', member_id=context.member_id) %}
{% set effective_cta_href = context.cta_href if context.cta_href and not context.cta_href.startswith('#') else ad_url %}
{% set cta_label = context.cta_text or '檢視生成廣告' %}
<body>
    <header>
        <h1>你的專屬折扣</h1>
        <nav>
            <ul id="nav-links">
                <li class="event"><a href="#" title="促銷活動">促銷活動</a></li>
                <li class="shop"><a href="#" title="店舖管理">店舖管理</a></li>
                <li class="product"><a href="#" title="商品管理">商品管理</a></li>
                <li class="payment"><a href="#" title="金流管理">金流管理</a></li>
                <li class="customer active"><a href="#" title="顧客資料">顧客資料</a></li>
            </ul>
        </nav>
    </header>
    <main id="customer-profile">
        <article id="customer-information">
            <h2 class="hide">顧客資料</h2>
            <figure class="customer-photo">
                <img src="{{ profile.photo_url or url_for('static', filename='images/face.jpg') }}" alt="Customer Photo">
                <figcaption>{{ context.detected_at or timings.get('detected_at') or '--' }}</figcaption>
            </figure>
            <section class="customer-infolist">
                <ul class="customer-basic-info">
                    <li class="customer-name">{{ profile.name or '匿名顧客' }}</li>
                    <li class="customer-level general">{{ profile.member_status or (context.audience == 'new' and '訪客' or '一般會員') }}</li>
                    <li>Face ID：{{ context.member_id }}</li>
                    <li>會員編號：{{ profile.member_code or '尚未註冊' }}</li>
                    <li>會員狀態：{{ profile.member_status or '未知' }}</li>
                    <li>加入日期：{{ profile.joined_at or '--' }}</li>
                    <li>點數餘額：{{ profile.points_balance if profile.points_balance is not none else 0 }} 點</li>
                </ul>
                <ul class="customer-contact-info">
                    <li>性別：{{ profile.gender or '未填寫' }}</li>
                    <li>出生年月：{{ profile.birth_date or '未填寫' }}</li>
                    <li>聯絡電話：{{ profile.phone or '未填寫' }}</li>
                    <li>電子郵件：{{ profile.email or '未填寫' }}</li>
                    <li>郵遞地址：{{ profile.address or '未填寫' }}</li>
                    <li>職業 / 產業別：{{ profile.occupation or '未填寫' }}</li>
                </ul>
            </section>
        </article>
        <article id="customer-details">
            <section id="customer-tags">
                <h2>顧客標籤</h2>
                <ul class="customer-taglist">
                    {% if profile.profile_label %}<li>#{{ profile.profile_label }}</li>{% endif %}
                    {% if predicted.category_label %}<li>#{{ predicted.category_label }}</li>{% endif %}
                </ul>
            </section>
            <section id="customer-preferences">
                <h2 class="hide">顧客偏好</h2>
                <ul class="customer-preferencelist">
                    <li><span>偏好商品類別</span>{{ predicted.category_label or '健康飲品' }}</li>
                    <li><span>最近消費時間</span><i>{{ first_purchase.purchased_at if first_purchase else '--' }}</i></li>
                    <li><span>本季消費頻率</span>每月 <i>{{ purchases|length }}</i> 次</li>
                    <li><span>平均消費金額</span>NT$ <i>{{ '%.0f' % (first_purchase.total_price or 0) if first_purchase else '0' }}</i></li>
                </ul>
            </section>
            <section id="customer-purchase-history">
                <h2 class="hide">顧客購買歷史</h2>
                <span id="tab-1">1</span>
                <span id="tab-2">2</span>
                <span id="tab-3">3</span>
                <span id="tab-4">4</span>
                <div id="tab">
                    <ul>
                        <li><a href="#tab-1" title="感興趣商品推估">感興趣商品推估</a></li>
                        <li><a href="#tab-2" title="歷史消費紀錄">歷史消費紀錄</a></li>
                        <li><a href="#tab-3" title="動線區域停留時間">動線區域停留時間</a></li>
                        <li><a href="#tab-4" title="參與活動紀錄">參與活動紀錄</a></li>
                    </ul>
                    <div class="tab-content-1">
                        <h3 class="hide">感興趣商品推估</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>內部商品編號</th>
                                    <th>商品名稱</th>
                                    <th>商品類別</th>
                                    <th>商品價格</th>
                                    <th>商品<br/>查閱率</th>
                                    <th>預估購買機率</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if items %}
                                    {% for item in items[:7] %}
                                        <tr>
                                            <td>{{ item.product_code or '--' }}</td>
                                            <td>{{ item.product_name or '--' }}</td>
                                            <td>{{ item.category_label or item.category or '--' }}</td>
                                            <td>{% if item.price is not none %}${{ '%.0f' % item.price }}{% else %}--{% endif %}</td>
                                            <td>
                                                {% if item.view_rate_percent is not none %}
                                                    {{ '%.1f' % item.view_rate_percent }}%
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.probability_percent is not none %}
                                                    {{ '%.1f' % item.probability_percent }}%
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="6">暫無預測資料，歡迎加入會員以獲得更多推薦。</td></tr>

{% set context = context if context is defined else None %}
{% set purchases = purchases if purchases is defined else (context.purchases if context and context.purchases is defined else []) %}
{% set insights = context.insights if context and context.insights is defined else None %}
{% set scenario = scenario_key|default(insights.scenario if insights and insights.scenario is defined else '') %}
{% set hero_image_url = hero_url %}
{% set scenario_key = scenario %}

{% if is_v2 %}
  {# 新版樣式：partial（帶 debug 支援） #}
  {% set debug = (request.args.get('debug') == '1') %}
  {% include "partials/ad_hero.html" %}

{% else %}
  {# 舊版樣式（Codex 版）：保留 insight 卡片與歷史清單 #}
  <div class="banner">
    <div class="hero">
      <img src="{{ hero_url }}"
           alt="廣告主視覺 {{ scenario|default('') }}">
    </div>

    {% set legacy_copy = copy if copy is defined and copy else None %}
    {% set headline = context.headline if context and context.headline is defined else (legacy_copy.title if legacy_copy and legacy_copy.title is defined else "智慧零售廣告看板") %}
    <h1>{{ headline }}</h1>

    <div class="member-code">
      {% if context and context.member_code %}
        商場會員代號：{{ context.member_code }}
      {% else %}
        尚未綁定商場會員代號，歡迎至服務台完成綁定
      {% endif %}
    </div>

    <div class="subheading">
      {% set subheading = context.subheading if context and context.subheading is defined else (legacy_copy.subtitle if legacy_copy and legacy_copy.subtitle is defined else "") %}
      {{ subheading }}
    </div>

    <div class="highlight">
      {% set highlight_text = context.highlight if context and context.highlight is defined else None %}
      {% if highlight_text %}
        {{ highlight_text }}
      {% else %}
        {% set bullets = legacy_copy.bullets if legacy_copy and legacy_copy.bullets is defined and legacy_copy.bullets else ["入會禮","生日禮","點數回饋"] %}
        {{ bullets|join(" · ") }}
      {% endif %}
    </div>

    <div class="insight-card">
      {% if scenario == 'brand_new' %}
        <span class="badge">新客偵測</span>
        <p>第一次來店，尚未累積消費紀錄，立即推播加入會員與公版歡迎廣告。</p>
        <p>完成註冊即可領取開卡禮，並於現場啟用專屬折扣。</p>
      {% elif scenario == 'repeat_purchase' %}
        <span class="badge">回購洞察</span>
        <p>近期 {{ insights.repeat_count if insights and insights.repeat_count is defined else "多次" }} 次都選擇「{{ insights.recommended_item if insights and insights.recommended_item is defined else "熱門品項" }}」，系統自動生成此商品的個人化推播。</p>
        <p>建議同步展示加價購組合或升級方案，提高客單價。</p>
      {% else %}
        <span class="badge">老會員預測</span>
        <p>根據歷史消費，AI 預估再次購買「{{ insights.recommended_item if insights and insights.recommended_item is defined else "偏好品項" }}」的機率約 {{ insights.probability_percent if insights and insights.probability_percent is defined else "—" }}。</p>
        <p>推播會員專屬優惠，並提醒可於收銀台加碼點數。</p>
      {% endif %}
    </div>

    {% if purchases %}
      <div class="history">
        <h2>歷史消費紀錄</h2>
        <ul>
          {% for purchase in purchases %}
            <li>
              <span class="item">{{ purchase.item }}</span>
              <span class="date">{{ purchase.purchased_at }}</span>
              {% set qty = '{:g}'.format(purchase.quantity) if purchase.quantity is defined else '1' %}
              <span class="meta">
                單價：${{ '%.0f'|format(purchase.unit_price) if purchase.unit_price is defined else '—' }}
                ｜數量：{{ qty }}
                ｜總價：${{ '%.0f'|format(purchase.total_price) if purchase.total_price is defined else '—' }}
              </span>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <div class="history history-empty">尚無消費紀錄</div>
    {% endif %}
  </div>
{% endif %}


</body>
</html>
